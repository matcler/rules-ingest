{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ghostplaier.local/schemas/rules-ingest/structured.schema.json",
  "title": "Rules-Ingest Structured Rule (Constraints Only)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "id",
    "kind",
    "name",
    "pack",
    "constraints"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema semver of this structured format."
    },
    "id": {
      "type": "string",
      "pattern": "^[a-z0-9_.:-]+$"
    },
    "kind": {
      "type": "string",
      "enum": [
        "combat_rule",
        "spell",
        "feat",
        "feature",
        "condition"
      ],
      "description": "High-level SRD entity type."
    },
    "name": {
      "type": "string",
      "minLength": 1
    },
    "pack": {
      "type": "string",
      "pattern": "^[A-Z0-9_]+$"
    },
    "source": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "corpus": {
          "type": "string"
        },
        "ref": {
          "type": "string"
        }
      }
    },
    "constraints": {
      "type": "array",
      "minItems": 0,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "type"
        ],
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "requires_phase",
              "requires_action_cost",
              "requires_reaction",
              "requires_bonus_action",
              "requires_initiative_set",
              "requires_combat_active",
              "requires_your_turn",
              "requires_target",
              "requires_target_not_self",
              "forbids_target_types",
              "requires_range_max",
              "requires_adjacent_target",
              "requires_line_of_sight",
              "requires_equipment",
              "forbids_destination_occupied"
            ]
          },
          "eventType": {
            "type": "string",
            "enum": [
              "ACTION_PROPOSED",
              "TURN_ENDED",
              "ADVANCE_TURN"
            ]
          },
          "actionType": {
            "type": "string",
            "pattern": "^[A-Z_]+$",
            "description": "Optional filter for ACTION_PROPOSED (MOVE/ATTACK/etc.)."
          },
          "expectedPhase": {
            "type": "string",
            "enum": [
              "INIT",
              "ACTION",
              "END"
            ]
          },
          "actionCost": {
            "type": "string",
            "enum": [
              "ACTION",
              "BONUS_ACTION",
              "REACTION"
            ]
          },
          "maxFeet": {
            "type": "number",
            "minimum": 0
          },
          "metric": {
            "type": "string",
            "enum": [
              "MANHATTAN",
              "CHEBYSHEV",
              "EUCLIDEAN"
            ]
          },
          "targetTypes": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^[A-Z0-9_]+$"
            }
          },
          "equipment": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^[A-Z0-9_]+$"
            }
          },
          "notes": {
            "type": "string",
            "maxLength": 240
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          }
        }
      }
    },
    "extraction": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "method": {
          "type": "string",
          "enum": [
            "manual",
            "llm"
          ]
        },
        "model": {
          "type": "string"
        },
        "date": {
          "type": "string"
        }
      }
    }
  }
}